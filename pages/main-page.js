import useSWR from "swr";
import { useRouter } from "next/router";
import Cookie from "universal-cookie";
import Layout from "../components/Layout";
import Head from "next/head";
import Post from "../components/Post";

const cookie = new Cookie();

const fetcher = async (url) => {
  const token = cookie.get("access_token");
  const res = await fetch(url, {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      Authorization: `JWT ${token}`,
    },
  });
  if (!res.ok) {
    throw new Error("Error while fetching posts");
  }
  const posts = await res.json();
  return posts;
};

export default function MainPage() {
  const router = useRouter();
  const { data: filteredPosts, error } = useSWR(
    `${process.env.NEXT_PUBLIC_RESTAPI_URL}api/post/`,
    fetcher
  );

  if (error) return <div>Failed to load posts</div>;
  if (!filteredPosts) return <div>Loading...</div>;

  return (
    <Layout title="Main">
      <Head>
        <title>グルgram</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>
        <ul>
          {Array.isArray(filteredPosts) &&
            filteredPosts.map((post) => <Post key={post.id} post={post} />)}
        </ul>
        <h1 className="text-2xl font-bold mb-4">Coming Soon...</h1>
      </main>
    </Layout>
  );
}
